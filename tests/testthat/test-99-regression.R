context("Regression tests for rodent, ant and plant output")

portal_data_path <- tempdir()

test_that("data generated by default setting is same", {
  data <- abundance(portal_data_path, level = 'Site',
                    type = "Rodents", plots = "all", unknowns = FALSE,
                    min_plots = 24, shape = "crosstab", time = "period")
  data <- data %>% dplyr::filter(period < 434)
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "f7365a1b64bd3aa30579abd37c6de863")
})

test_that("data generated by level = treatment, plots = longterm is same", {
  data <- abundance(portal_data_path, level = 'treatment', plots = "longterm")
  data <- data %>% dplyr::filter(period < 434)
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "5516d861d63a1305ff4b39b62c29e5a1")
})

test_that("data generated by level = plot, time = newmoon, type = granivore, shape = flat is same", {
  data <- abundance(portal_data_path, level = 'plot', type = "granivores",
                    shape = "flat", time = "newmoon")
  data <- data %>% dplyr::filter(newmoonnumber < 465)
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "22f018525c242edaa3f94814e04d230b")
})

test_that("data generated by unknowns = T, min_plots = 1 is same", {
  data <- abundance(portal_data_path, min_plots = 1, unknowns = TRUE)
  data <- data %>% dplyr::filter(period < 434)
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "716cba45b04466dea49bccd2844ef5da")
})

test_that("data generated by plots = c(4, 8, 10, 12) is same", {
  data <- get_rodent_data(path = portal_data_path, plots = c(4, 8, 10, 12),
                  na_drop = TRUE, zero_drop = FALSE)
  data <- data %>% dplyr::filter(period < 450)
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "c4eb4083894c3790ceeba6b8ef8d3579")
})

test_that("biomass data generated by level = plot is same", {
  data <- biomass(portal_data_path, level = "plot")
  data <- data %>% dplyr::filter(period < 434)
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "aa996a24cf58b1315a3a1dc29349de23")
})

test_that("biomass data generated by min_plots = 1 is same", {
  data <- biomass(portal_data_path, min_plots = 1)
  data <- data %>% dplyr::filter(period < 434)
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "78312c1d686891d5b7b4e2f116878221")
})

test_that("data generated by default setting is same (plants)", {
  data <- plant_abundance(portal_data_path, level = 'Site',
                          type = "All", plots = "all", unknowns = FALSE,
                          correct_sp = TRUE, shape = "flat", na_drop = TRUE,
                          zero_drop = TRUE, min_quads = 1, effort = TRUE)
  data <- data %>% dplyr::filter(year < 2015)
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "a81e273214c0eaddadd42755e5b2887a")
})

test_that("data generated by type = Shrubs, unknowns = T, correct_sp = F is same (plants)", {
  data <- plant_abundance(portal_data_path, level = 'Site',
                          type = "Shrubs", plots = "all", unknowns = TRUE,
                          correct_sp = FALSE, shape = "flat", na_drop = TRUE,
                          zero_drop = TRUE, min_quads = 1, effort = TRUE)
  data <- data %>% dplyr::filter(year < 2015)
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "8213afa103bd1ac96e04cf5e2b1f941d")
})

test_that("data generated by level = Plot, type = Annuals, plots = longterm is same (plants)", {
  data <- plant_abundance(portal_data_path, level = 'Plot',
                          type = "Annuals", plots = "longterm")
  data <- data %>% dplyr::filter(year < 2015)
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "10a08dc4bd6d63c31270acc7f678134d")
})

test_that("data generated by default setting is same (ant colony_presence_absence)", {
  data <- colony_presence_absence(portal_data_path, level = 'Site', rare_sp = F, unknowns = F)
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "cde8c5498581739d29406c107ff09de6")
})

test_that("data generated by default setting is same (ant bait_presence_absence)", {
  data <- bait_presence_absence(portal_data_path, level = 'Site')
  attributes(data) <- attributes(data)[sort(names(attributes(data)))]
  expect_identical(digest::digest(data), "aeffcd88c83fbe683c420743dc45403e")
})
