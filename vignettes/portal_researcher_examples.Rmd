---
title: "Examples of How Portal Researchers Are Using the Package"
author: "Ellen K. Bledsoe"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The `portalr` package started out as a series of scripts to quickly summarize the [Portal data](https://github.com/weecology/PortalData) in ways the data is commonly used. It developed from there into a formalized package to deal with all the quirky data manipulation under the hood. Now, the researchers who are currently collecting data at Portal have started actively using the package in their own work. We include some quick examples below.

## Installing the Package

First, we need to install the `portalr` package if we haven't done so already. We'll also load `tidyverse` which has many packages for data manipulation and plotting.
```{r, warning = FALSE, message = FALSE}
#devtools::install_github("weecology/portalr")
library(portalr)
library(tidyverse)
```



# Rodent Biomass Ratios between Plot Treatment Types

One thing we can do with the Portal rodent data is look at the ratio of biomass between the control plots and the kangaroo rat exclosue plots has changed through time. 

## Getting the Data We Want

Because we are going to compare biomass between plot types, we need to know the biomass on each plot. To achieve this, we can set `level = "plot"` 

```{r, warning = FALSE, message = FALSE}
biomass_data <- get_rodent_data(path = "repo", 
                                level = "plot", 
                                output = "biomass",
                                time = "date")
```

Note that the `path` argument in the `get_rodent_data` function has been set to "repo." While you can choose the download all of the Portal data onto your local computer and then load the data into R, you can also get the data directly from the GitHub repository by setting `path = "repo"` as we've done here.


The data structure will look like this, with columns for the date, treatment, plot number, and each species:
```{r, echo=FALSE, results='asis'}
knitr::kable(tail(biomass_data))
```

## Workign with the Data

Let's select only the rows we want. Since we are comparing control plots and exclosure plots, we can filter for only those treatment types. Based on information about the plot treatment switches that can be found in this [Readme file](https://github.com/weecology/PortalData/tree/master/SiteandMethods) in the PortalDate repo, I also want to select censuses in the years 1988-2014.

```{r, warning = FALSE, message = FALSE}

biomass_data <- biomass_data %>% 
  # split the date column into year, month, and day
  separate(col = censusdate, into = c("year", "month", "day"), sep = "-") %>% 
  filter(year >= 1988 & year < 2015,
         treatment == "control" | treatment == "exclosure") 
```

We can get the total biomass for each plot per census by summing the mass of all the species per row. From there, we will sum by year for each treatment type. Then, we can create the exclosure:control ratio.

```{r, warning = FALSE, message = FALSE}
# sum across rows and rename column
biomass_data_rowSums <- as.data.frame(rowSums(biomass_data[,6:26], na.rm = TRUE))
colnames(biomass_data_rowSums) <- c("rowSums")

# summarise biomass to get total by period and plot type
biomass_total <- cbind(biomass_data, biomass_data_rowSums) %>%
  group_by(year, treatment) %>%
  summarise(totals = sum(rowSums))

# make a column with the exclosure:control ratio
biomass_ratio <- tidyr::spread(biomass_total, treatment, totals) %>% 
  mutate(EX_to_CO_ratio = exclosure/control)
```

## Plotting the Ratios

We can finally plot the data!

```{r, echo = FALSE, fig.width = 6, fig.height = 4}
biomass_ratio$year <- as.numeric(biomass_ratio$year)
ggplot(biomass_ratio, aes(year, EX_to_CO_ratio, group = 1)) +
  annotate(geom = "rect", fill = "grey", alpha = 0.4,
           xmin = 1995, xmax = 1998,
           ymin = -Inf, ymax = Inf) +
  annotate(geom = "rect", fill = "grey", alpha = 0.4,
           xmin = 2008, xmax = 2010,
           ymin = -Inf, ymax = Inf) +
  geom_point(size = 3) +
  geom_line()+
  ylab("Kangaroo Rat Exlcosure:Control Biomass") +
  theme_classic() +
  theme(panel.border = element_rect(fill = NA, colour = "black"),
        axis.title.x = element_text(face = "bold", size = 14, margin = margin(t = 20)),
        axis.title.y = element_text(face = "bold", size = 14, margin = margin(r = 20)),
        axis.text.x = element_text(face = "bold", size = 12),
        axis.text.y = element_text(face = "bold", size = 12))
```

# Working with Plant Data
