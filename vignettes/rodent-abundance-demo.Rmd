---
title: "Portal Rodent Abundance Demo"
author: "Hao Ye"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette: 
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Portal Rodent Abundance Demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  
---

# Introduction

This vignette is a basic guide to begin exploring the Portal data, and the rodent abundance data, specifically.

```{r}
library(portalr)
library(dplyr)
library(ggplot2)
```

# Retrieving the Data

Note that this package does not contain the actual Portal data, which resides online in a [GitHub repository](https://github.com/weecology/PortalData).

First, we check whether we already have the data. If we don't have the data, or if the version we have isn't the most recent, we use the `download_observations` function to download the latest copy of the data.

```{r}
my_path <- "." # use current folder to store downloaded data
rodent_file <- FullPath('PortalData/Rodents/Portal_rodent.csv', my_path)

observations_are_new = function(base_folder='~'){
  md5_file = './Portal_rodent.md5'
  rodent_file= FullPath('PortalData/Rodents/Portal_rodent.csv', base_folder)
  if(!file.exists(rodent_file)) stop('Rodent observations not present. Please run download_observations()')

  if(!file.exists(md5_file)) {
    old_md5=''
  } else {
    old_md5 = read.csv(md5_file, header = FALSE, stringsAsFactors = FALSE)$V1
  }

  new_md5 = as.character(tools::md5sum(rodent_file))

  if(old_md5 == new_md5){
    return(FALSE)
  } else {
    sink(md5_file)
    writeLines(new_md5)
    sink()
    return(TRUE)
  }

}

message("!file.exists(rodent_file) => ", !file.exists(rodent_file))
message("observations_are_new(my_path) => ", observations_are_new(my_path))

if(!file.exists(rodent_file) || # if data files are missing OR
   observations_are_new(base_folder = my_path)) # if data is not up to date
{
  download_observations(base_folder = my_path) # download from GitHub repo
}
```

# Rodent Abundances

We just want a basic summary of the rodent abundance data, so we can use the `abundance` function. However, by default it identifies the monthly summary by `period`, which is an index, $i$, for the $i$-th sample. To convert back into an ISO date, we load up the table of sampling dates and join the two tables.

```{r}
rodent_data_all <- loadData(path = my_path)

date_LUT <- rodent_data_all[[4]] %>%
  select("period", "censusdate") # grab the lookup table for period -> censusdate

rodent_abundance <- abundance(path = my_path) %>%
  left_join(date_LUT, by = "period") %>%
  mutate(censusdate = as.Date(censusdate)) %>%
  select(censusdate, period, everything())

print(summary(rodent_abundance))
```

Let's convert the data to long format for easier facetting:
```{r}
rodent_abundance <- rodent_abundance %>%
  tidyr::gather(species, abundance, -censusdate, -period)

species_idx <- match(rodent_abundance$species, rodent_data_all[[2]]$species)
rodent_abundance$scientific_name <- rodent_data_all[[2]]$scientificname[species_idx]

```

## Plot abundance over time

```{r, fig.cap = "Monthly Abundance of rodents (all plots)", fig.width = 7.5, fig.height = 10}
my_plot <- ggplot(rodent_abundance, 
                  aes(x = censusdate, y = abundance)) + 
  scale_x_date(date_breaks = "4 years") + 
  facet_wrap(~scientific_name, scales = "free_y", ncol = 3) + 
  geom_line() + 
  cowplot::theme_cowplot() + 
  theme(axis.text.x = element_text(angle=90, hjust=1))

print(my_plot)
```



